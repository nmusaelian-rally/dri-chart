<!DOCTYPE html>
<html>
<head>
    <title>DRI Chart</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",weeks:[],numberOfWeeks:24,arrOfCreationDateFilters:[],arrOfFixedAndLimitedByCreationDateFilters:[],created:[],fixedWithinTTR:[],ttr1:28,ttr2:84,allData:[],categories:[],launch:function(){this._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait.This may take long..."}),this._myMask.show(),this.getDates(),this.createFilters(),this.makeStore(),this.defectDetails=Array(this.numberOfWeeks);for(var i=0;this.numberOfWeeks>i;i++)this.defectDetails[i]=[];var gridPanel=Ext.create("Ext.Panel",{itemId:"gridPanel",layout:{type:"hbox",align:"stretch"},items:[{xtype:"panel",title:"4 week and 12 week DRI. Click on a row to see details",itemId:"childPanel1",flex:1},{xtype:"panel",title:"Last Week or Selected Week Defects",itemId:"childPanel2",flex:2}]}),chartPanel=Ext.create("Ext.Panel",{title:"DRI Chart",itemId:"chartPanel"});this.add(gridPanel),this.add(chartPanel)},getDates:function(){var now=new Date,today=now.getDay(),saturday=6,padding=1,howFarBack=this.numberOfWeeks+padding,saturdayDates=[],closestSaturday=null,prevSaturday=null,weeks=[],daysFromLastSaturday=today-saturday;closestPastSaturday=new Date(now-864e5*daysFromLastSaturday-6048e5),saturdayDates.push(Rally.util.DateTime.format(closestPastSaturday,"Y-m-d"));for(var i=1;howFarBack>i;i++){var prevSaturday=new Date(closestPastSaturday-6048e5);saturdayDates.push(Rally.util.DateTime.format(prevSaturday,"Y-m-d")),closestPastSaturday=prevSaturday}for(var i=0;saturdayDates.length-1>i;i++){var week={};week.end=saturdayDates[i],week.start=saturdayDates[i+1],this.weeks.push(week)}},createFilters:function(){var tagFilter,codeResolitionFilter,closedFilter,fixedFilter,closedDateFilters=[],creationDateFilters=[];tagFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Tags.Name",operator:"contains",value:"Customer Voice"}),closedFilter=tagFilter.and(Ext.create("Rally.data.wsapi.Filter",{property:"State",value:"Closed"})),codeResolitionFilter=Rally.data.wsapi.Filter.or([{property:"Resolution",value:"Code Change"},{property:"Resolution",value:"Database/Metadata Change"},{property:"Resolution",value:"Configuration Change"}]),fixedFilter=closedFilter.and(codeResolitionFilter),_.each(this.weeks,function(week){var creationDateFilter=Rally.data.wsapi.Filter.and([{property:"CreationDate",operator:">=",value:week.start},{property:"CreationDate",operator:"<",value:week.end}]);this.arrOfCreationDateFilters.push(tagFilter.and(creationDateFilter)),this.arrOfFixedAndLimitedByCreationDateFilters.push(fixedFilter.and(creationDateFilter))},this),console.log(this.arrOfCreationDateFilters.length," Creation Date Filters--------"),_.each(this.arrOfCreationDateFilters,function(filter){console.log(""+filter)},this),console.log(this.arrOfFixedAndLimitedByCreationDateFilters.length," Fixed Filters limited by Creation Dates-----------"),_.each(this.arrOfFixedAndLimitedByCreationDateFilters,function(filter){console.log(""+filter)},this)},makeStore:function(){this.concatArraysOfFilters=this.arrOfCreationDateFilters.concat(this.arrOfFixedAndLimitedByCreationDateFilters),this.defectStore=Ext.create("Rally.data.wsapi.Store",{model:"Defect",fetch:["Name","State","Resolution","FormattedID","CreationDate","ClosedDate","Owner","Project"],limit:1/0}),this.applyFiltersToStore(0)},applyFiltersToStore:function(i){this.defectStore.addFilter(this.concatArraysOfFilters[i]),this.defectStore.load({scope:this,callback:function(records,operation){operation.wasSuccessful()&&(this.numberOfWeeks>i?(this.created.push(records.length),_.each(records,function(record){var owner=record.get("Owner");this.defectDetails[i].push({_ref:record.get("_ref"),FormattedID:record.get("FormattedID"),Name:record.get("Name"),State:record.get("State"),Resolution:record.get("Resolution"),Owner:owner&&owner._refObjectName||"None",Project:record.get("Project")._refObjectName,CreationDate:Rally.util.DateTime.format(record.get("CreationDate"),"Y-m-d"),ClosedDate:Rally.util.DateTime.format(record.get("ClosedDate"),"Y-m-d")})},this)):this.fixedWithinTTR.push(this.getFixedDefectsWithinTTR(records)),this.defectStore.clearFilter(records.length),this.concatArraysOfFilters.length-1>i?this.applyFiltersToStore(i+1):this.makeCustomStore())}})},getFixedDefectsWithinTTR:function(records){var closedDefectsWithinTTR1=[],closedDefectsWithinTTR2=[],closedDefectsWithinAllTTRs=[],arrayOfDataObjects=[];return _.each(records,function(record){var created=new Date(record.get("CreationDate")),closed=new Date(record.get("ClosedDate")),diff=Math.floor((closed-created)/864e5);this.ttr2>=diff&&closedDefectsWithinTTR2.push(record),this.ttr1>=diff&&closedDefectsWithinTTR1.push(record)},this),closedDefectsWithinAllTTRs.push(closedDefectsWithinTTR1.length),closedDefectsWithinAllTTRs.push(closedDefectsWithinTTR2.length),closedDefectsWithinAllTTRs},makeCustomStore:function(){this.fixedWithinTTR=_.flatten(this.fixedWithinTTR);for(var fixedWithinTTR1=[],fixedWithinTTR2=[],index=0;this.fixedWithinTTR.length>index;index++)0==index%2?fixedWithinTTR1.push(this.fixedWithinTTR[index]):fixedWithinTTR2.push(this.fixedWithinTTR[index]);for(var startDates=[],endDates=[],dri1=[],dri2=[],arrOfArraysOfColumnValues=[],f=0,c=0;fixedWithinTTR1.length>f;f++,c++)dri1.push((100*(fixedWithinTTR1[f]/this.created[c])).toFixed(2));for(var f=0,c=0;fixedWithinTTR2.length>f;f++,c++)dri2.push((100*(fixedWithinTTR2[f]/this.created[c])).toFixed(2));arrOfArraysOfColumnValues.push(this.created),arrOfArraysOfColumnValues.push(fixedWithinTTR1),arrOfArraysOfColumnValues.push(fixedWithinTTR2),arrOfArraysOfColumnValues.push(dri1),arrOfArraysOfColumnValues.push(dri2),arrOfArraysOfColumnValues.push(startDates),arrOfArraysOfColumnValues.push(endDates),_.each(this.weeks,function(week){startDates.push(week.start),endDates.push(week.end)});for(var arrOfArraysOfRowValues=_.zip(arrOfArraysOfColumnValues),arrOfObjectsOfRowValues=[],i=0;arrOfArraysOfRowValues.length>i;i++){for(var o={},j=0;arrOfArraysOfRowValues[i].length>j;j++)o[j]=arrOfArraysOfRowValues[i][j];arrOfObjectsOfRowValues.push(o)}for(var i=arrOfObjectsOfRowValues.length-1;i>=0;i--)this.allData.push(arrOfObjectsOfRowValues[i]);this.makeGrid(arrOfObjectsOfRowValues)},makeGrid:function(data){var that=this;this._myMask.hide(),this.down("#childPanel1").add({xtype:"rallygrid",itemId:"defectGrid",store:Ext.create("Rally.data.custom.Store",{data:data}),listeners:{select:this.getDetails,load:function(selModel,record,index,options){this.getDetails(selModel,record,0,options)},scope:this},columnCfgs:[{text:"Start Week",dataIndex:"5"},{text:"End Week",dataIndex:"6"},{text:"Created Defects",dataIndex:"0"},{text:"Fixed Defects (TTR <= 4 weeks)",dataIndex:"1"},{text:"Fixed Defects (TTR <= 12 weeks)",dataIndex:"2"},{text:"4 Week DRI %",dataIndex:"3"},{text:"12 Week DRI %",dataIndex:"4"}],showPagingToolbar:!1}),this.prepareChart()},getDetails:function(selModel,record,rowIndex,options){var removeAdminClosedIfClosed=[];_.each(this.defectDetails[rowIndex],function(obj){obj.ClosedDate?(console.log("closed defect",obj.FormattedID),("Code Change"===obj.Resolution||"Database/Metadata Change"===obj.Resolution||"Configuration Change"===obj.Resolution)&&removeAdminClosedIfClosed.push(obj)):removeAdminClosedIfClosed.push(obj)});var detailsGrid=this.down("#detailsGrid");detailsGrid&&Ext.ComponentQuery.query("#childPanel2")[0].remove(Ext.ComponentQuery.query("#detailsGrid")[0],!0),this.down("#childPanel2").add({xtype:"rallygrid",itemId:"detailsGrid",store:Ext.create("Rally.data.custom.Store",{data:removeAdminClosedIfClosed}),columnCfgs:[{text:"FormattedID",dataIndex:"FormattedID",xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name",flex:1},{text:"State",dataIndex:"State"},{text:"Owner",dataIndex:"Owner"},{text:"Project",dataIndex:"Project"},{text:"CreationDate",dataIndex:"CreationDate"},{text:"ClosedDate",dataIndex:"ClosedDate"},{text:"Resolution",dataIndex:"Resolution"}],showPagingToolbar:!0,cls:""})},prepareChart:function(){this.series=[],this.data=[[],[],[],[]];var chartData=[],numOfWeeksRunningDri1=this.ttr1/7,numOfWeeksRunningDri2=this.ttr2/7;_.each(this.allData,function(o){chartData.push({dri1:o[3],dri2:o[4],endWeek:o[6]})}),console.log("chartData..."),_.each(chartData,function(o){this.categories.push(o.endWeek),this.data[0].push(parseFloat(o.dri1)),this.data[1].push(parseFloat(o.dri2))},this),console.log(" this.data[0] before splice....",this.data[0]),this.data[2]=this.data[0].splice(0,this.data[0].length-numOfWeeksRunningDri1),this.data[3]=this.data[1].splice(0,this.data[1].length-numOfWeeksRunningDri2);for(var a=0;this.numberOfWeeks-numOfWeeksRunningDri1>a;a++)this.data[0].unshift(null);for(var b=0;this.numberOfWeeks-numOfWeeksRunningDri2>b;b++)this.data[1].unshift(null);console.log("this.data..."),_.each(this.data,function(subArray){console.log(subArray)}),this.series.push({name:"4 week running DRI",data:this.data[0],color:["#87CEEB"],dashStyle:"Dot"}),this.series.push({name:"4 week DRI",color:["#008080"],data:this.data[2]}),this.series.push({name:"12 week running DRI",data:this.data[1],color:["#8FBC8F"],dashStyle:"Dot"}),this.series.push({name:"12 week DRI",color:["#008080"],data:this.data[3]}),this.makeChart()},makeChart:function(){var that=this;this.down("#chartPanel").add({xtype:"rallychart",chartConfig:{chart:{type:"line",zoomType:"xy"},title:{text:"4 week and 12 week DRI"},colors:["#87CEEB","#8FBC8F","#008080","#008080"],xAxis:{title:{enabled:!0},tickInterval:1,startOnTick:!0,endOnTick:!0,showLastLabel:!0,allowDecimals:!1},yAxis:{title:{text:"Defect Resolution Index"},allowDecimals:!1,min:0},plotOptions:{line:{connectNulls:!1}}},chartData:{series:that.series,categories:that.categories}})}});

            Rally.launchApp('CustomApp', {
                name:"DRI Chart",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app .rally-grid .x-grid-data-row:nth-child(-n+12) .x-grid-cell:last-child{color:#808080}.app .rally-grid .x-grid-data-row:nth-child(n+13) .x-grid-cell:last-child .x-grid-cell-inner{font-family:NotoSansBold,Helvetica,Arial}.app .rally-grid .x-grid-data-row:nth-child(-n+4) .x-grid-cell:nth-child(7){color:#808080}.app .rally-grid .x-grid-data-row:nth-child(n+5) .x-grid-cell:nth-child(7) .x-grid-cell-inner{font-family:NotoSansBold,Helvetica,Arial}
    </style>
</head>
<body>
</body>
</html>
